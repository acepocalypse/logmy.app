<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Job Tracker (URL mode)</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
    h1,h2 { margin: .5rem 0; }
    input, textarea, select, button { width: 100%; padding: .5rem; margin: .3rem 0; box-sizing: border-box; }
    button { cursor: pointer; }
    .hidden { display: none; }
    table { width: 100%; margin-top: 2rem; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: .4rem .6rem; }
    th { background: #f9f9f9; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>üóÇÔ∏è Job / Internship Tracker</h1>

  <!-- Auth -->
  <section id="auth-section">
    <h2>Sign In</h2>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button id="login-btn">Log¬†In</button>
    <p id="auth-msg"></p>
  </section>

  <!-- Input job URL -->
  <section id="input-section" class="hidden">
    <h2>Paste Job‚ÄëPosting URL</h2>
    <input id="job-url" placeholder="https://‚Ä¶" />
    <button id="link-parse-btn">Fetch & Parse</button>
    <p id="link-msg"></p>
  </section>

  <!-- Confirm form -->
  <form id="confirm-form" class="hidden">
    <h2>Review Details</h2>
    <label>Company <input name="company" /></label>
    <label>Position <input name="position" /></label>
    <label>Location <input name="location" /></label>
    <label>Job¬†Type <select name="job_type"><option></option><option>Internship</option><option>Full‚ÄëTime</option></select></label>
    <label>Application¬†Date <input name="application_date" type="date" /></label>
    <label>Deadline <input name="deadline" type="date" /></label>
    <label>Status <select name="status"><option>Applied</option><option>Interview</option><option>Offer</option><option>Rejected</option></select></label>
    <label>Job¬†URL <input name="job_url" /></label>
    <label>Notes <input name="notes" /></label>
    <button type="submit">Save</button>
    <p id="submit-msg"></p>
  </form>

  <!-- Table of saved apps -->
  <section id="list-section" class="hidden">
    <h2>Your Applications</h2>
    <table id="apps-table"><thead><tr><th>Company</th><th>Position</th><th>Status</th><th>Applied</th></tr></thead><tbody></tbody></table>
  </section>

<script>
const SUPABASE_URL = 'https://jjneofugjszgivmisvup.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbmVvZnVnanN6Z2l2bWlzdnVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0ODg1NjQsImV4cCI6MjA2MjA2NDU2NH0.LnIMBqUpi0O3SvsGJmKR3_jkC7y7wiybpdzEV6KVy1s';
const API_BASE      = 'https://logmy-app.onrender.com';

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const email = document.getElementById('email');
const pass  = document.getElementById('password');
const login = document.getElementById('login-btn');
const authMsg = document.getElementById('auth-msg');

const inputSection = document.getElementById('input-section');
const linkBtn = document.getElementById('link-parse-btn');
const jobUrl  = document.getElementById('job-url');
const linkMsg = document.getElementById('link-msg');

const confirmForm = document.getElementById('confirm-form');
const submitMsg = document.getElementById('submit-msg');
const appsBody  = document.querySelector('#apps-table tbody');

login.addEventListener('click', async () => {
  authMsg.textContent = 'Logging in‚Ä¶';
  const { data, error } = await sb.auth.signInWithPassword({
    email: email.value,
    password: pass.value
  });
  if (error) authMsg.textContent = '‚ùå ' + error.message;
  else {
    authMsg.textContent = '‚úÖ';
    document.getElementById('auth-section').classList.add('hidden');
    inputSection.classList.remove('hidden');
    document.getElementById('list-section').classList.remove('hidden');
    loadApps();
  }
});

async function jwt() {
  const { data } = await sb.auth.getSession();
  return data.session?.access_token;
}

linkBtn.addEventListener('click', async () => {
  const url = jobUrl.value.trim();
  if (!url) return alert('Enter a URL');
  linkMsg.textContent = 'Fetching‚Ä¶';
  const res = await fetch(`${API_BASE}/link-parse`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ url })
  });
  const data = await res.json();
  if (!res.ok) return linkMsg.textContent = '‚ùå ' + data.error;
  linkMsg.textContent = '‚úÖ Parsed';
  [...confirmForm.elements].forEach(el => {
    if (el.name && data[el.name]) el.value = data[el.name];
  });
  confirmForm.classList.remove('hidden');
  confirmForm.scrollIntoView({behavior:'smooth'});
});

confirmForm.addEventListener('submit', async e => {
  e.preventDefault(); submitMsg.textContent='';
  const token = await jwt(); if (!token) return alert('login again');
  const payload = Object.fromEntries(new FormData(confirmForm));
  const res = await fetch(`${API_BASE}/submit`, {
    method:'POST', headers:{'Content-Type':'application/json', 'Authorization':'Bearer '+token},
    body: JSON.stringify(payload)
  });
  const out = await res.json();
  if (res.ok){
    submitMsg.textContent = '‚úÖ saved';
    confirmForm.reset(); confirmForm.classList.add('hidden'); jobUrl.value='';
    loadApps();
  } else submitMsg.textContent='‚ùå '+out.error;
});

async function loadApps(){
  appsBody.innerHTML='<tr><td colspan=4>Loading‚Ä¶</td></tr>';
  const { data, error } = await sb.from('applications').select('company,position,status,application_date').order('application_date',{ascending:false});
  if (error) appsBody.innerHTML='<tr><td colspan=4>'+error.message+'</td></tr>';
  else if (!data.length) appsBody.innerHTML='<tr><td colspan=4>None yet</td></tr>';
  else appsBody.innerHTML = data.map(r=>`<tr><td>${r.company}</td><td>${r.position}</td><td>${r.status}</td><td>${r.application_date||''}</td></tr>`).join('');
}
</script>
</body>
</html>
