<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@geist-ui/style@latest/dist/geist.css">
  <link rel="icon" href="favicon.svg" type="image/svg" />
  <title>logmy.app</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-quartz.css">
  <link rel="stylesheet" href="style.css">
  <style>
    .ag-tooltip { display: none !important; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
</head>
<body>
  <header id="app-header" class="hidden">
    <div class="logo-container">
      <img src="favicon.svg" alt="Logmy.app Logo" id="header-logo" />
      <span class="app-name-header">logmy.app</span>
    </div>
    <nav>
      <a href="#" id="nav-applications" class="active">Applications</a>
      <a href="#" id="nav-account">Account</a>
    </nav>
  </header>

  <main>
    <h1 id="main-title">logmy.app</h1>

    <section id="auth-section">
      <h2>Sign In</h2>
      <label for="email">Email</label>
      <input id="email" type="email" placeholder="you@example.com" />
      <label for="password">Password</label>
      <input id="password" type="password" placeholder="••••••••" />
      <button id="login-btn">Log In</button>
      <p id="auth-msg" class="message"></p>
    </section>

    <section id="input-section" class="hidden">
      <h2>Paste Job-Posting URL</h2>
      <input id="job-url" placeholder="https://job-posting-link.com/..." />
      <button id="link-parse-btn">Fetch & Parse</button>
      <p id="link-msg" class="message"></p>
    </section>

    <form id="confirm-form" class="hidden">
      <h2>Review Details</h2>
      <label for="company">Company</label>
      <input name="company" id="company" />
      <label for="position">Position</label>
      <input name="position" id="position" />
      <label for="location">Location</label>
      <input name="location" id="location" />
      <label for="job_type">Job Type</label>
      <select name="job_type" id="job_type">
        <option value=""></option>
        <option value="Internship">Internship</option>
        <option value="Full-Time">Full-Time</option>
        <option value="Contract">Contract</option>
        <option value="Part-Time">Part-Time</option>
      </select>
      <label for="application_date">Application Date</label>
      <input name="application_date" id="application_date" type="date" />
      <label for="deadline">Deadline</label>
      <input name="deadline" id="deadline" type="date" />
      <label for="status">Status</label>
      <select name="status" id="status">
        <option value="Applied">Applied</option>
        <option value="Interview">Interview</option>
        <option value="Offer">Offer</option>
        <option value="Rejected">Rejected</option>
        <option value="Wishlist">Wishlist</option>
      </select>
      <label for="job_url_form">Job URL</label>
      <input name="job_url" id="job_url_form" />
      <label for="notes">Notes</label>
      <textarea name="notes" id="notes" rows="3"></textarea>
      <button type="submit">Save Application</button>
      <p id="submit-msg" class="message"></p>
    </form>

    <section id="sheet-section" class="hidden">
      <h2>Your Applications</h2>
      <div class="sheet-actions">
        <button id="add-row">+ Add Row</button>
        <button id="export-csv" class="secondary">Export CSV</button>
      </div>
      <div id="myGrid" class="ag-theme-quartz" style="height: 600px; width: 100%;"></div>
    </section>

    <section id="account-section" class="hidden">
      <h2>Account Information</h2>
      <div class="account-details">
        <p><strong>Email:</strong> <span id="user-email-display"></span></p>
      </div>
      <button id="logout-btn">Log Out</button>
    </section>
  </main>

<script>
const SUPABASE_URL = 'https://jjneofugjszgivmisvup.supabase.co'
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbmVvZnVnanN6Z2l2bWlzdnVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0ODg1NjQsImV4cCI6MjA2MjA2NDU2NH0.LnIMBqUpi0O3SvsGJmKR3_jkC7y7wiybpdzEV6KVy1s'
const API_BASE = 'https://logmy-app.onrender.com'
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON)
let currentUser = null
let gridApi = null

const email_input = document.getElementById('email')
const password_input = document.getElementById('password')
const job_url_input = document.getElementById('job-url')
const app_header = document.getElementById('app-header')
const main_title = document.getElementById('main-title')
const auth_section = document.getElementById('auth-section')
const input_section = document.getElementById('input-section')
const sheet_section = document.getElementById('sheet-section')
const account_section = document.getElementById('account-section')
const confirm_form = document.getElementById('confirm-form')
const grid_div = document.querySelector('#myGrid')
const auth_msg = document.getElementById('auth-msg')
const link_msg = document.getElementById('link-msg')
const submit_msg = document.getElementById('submit-msg')
const user_email_display = document.getElementById('user-email-display')
const login_btn = document.getElementById('login-btn')
const logout_btn = document.getElementById('logout-btn')
const link_parse_btn = document.getElementById('link-parse-btn')
const add_row_btn = document.getElementById('add-row')
const export_csv_btn = document.getElementById('export-csv')
const nav_applications_link = document.getElementById('nav-applications')
const nav_account_link = document.getElementById('nav-account')

function displayMessage(el, msg, type) {
  el.textContent = msg
  el.className = 'message'
  if (type) el.classList.add(type)
}

function showSection(toShow) {
  [auth_section, input_section, sheet_section, account_section, confirm_form]
    .forEach(s => s.classList.add('hidden'))
  if (toShow) toShow.classList.remove('hidden')
}

function showApplicationsView() {
  showSection(null)
  input_section.classList.remove('hidden')
  sheet_section.classList.remove('hidden')
  if (confirm_form.classList.contains('user-initiated'))
    confirm_form.classList.remove('hidden')
  account_section.classList.add('hidden')
  nav_applications_link.classList.add('active')
  nav_account_link.classList.remove('active')
}

function showAccountView() {
  showSection(account_section)
  user_email_display.textContent = currentUser?.email || ''
  nav_applications_link.classList.remove('active')
  nav_account_link.classList.add('active')
}

function updateUIAfterLogin() {
  auth_section.classList.add('hidden')
  main_title.classList.add('hidden')
  app_header.classList.remove('hidden')
  showApplicationsView()
  loadGrid()
}

function updateUIAfterLogout() {
  app_header.classList.add('hidden')
  main_title.classList.remove('hidden')
  showSection(auth_section)
  currentUser = null
  if (gridApi) { gridApi.destroy(); gridApi = null }
  email_input.value = ''
  password_input.value = ''
  auth_msg.textContent = ''
  auth_msg.className = 'message'
}

nav_applications_link.addEventListener('click', e => {
  e.preventDefault()
  if (currentUser) showApplicationsView()
})
nav_account_link.addEventListener('click', e => {
  e.preventDefault()
  if (currentUser) showAccountView()
})

login_btn.addEventListener('click', async () => {
  displayMessage(auth_msg, 'Logging in…', 'neutral')
  const { data, error } = await sb.auth.signInWithPassword({
    email: email_input.value,
    password: password_input.value
  })
  if (error) displayMessage(auth_msg, `❌ ${error.message}`, 'error')
  else {
    currentUser = data.user
    displayMessage(auth_msg, '✅ Login Successful!', 'success')
    setTimeout(() => {
      updateUIAfterLogin()
      auth_msg.textContent = ''
      auth_msg.className = 'message'
    }, 500)
  }
})

logout_btn.addEventListener('click', async () => {
  const { error } = await sb.auth.signOut()
  if (error) alert(`Logout failed: ${error.message}`)
  else updateUIAfterLogout()
})

;(async () => {
  const { data: { session } } = await sb.auth.getSession()
  if (session?.user) {
    currentUser = session.user
    updateUIAfterLogin()
  } else {
    updateUIAfterLogout()
  }
})()

link_parse_btn.addEventListener('click', async () => {
  const url = job_url_input.value.trim()
  if (!url) {
    displayMessage(link_msg, 'Please enter a URL.', 'error')
    return
  }
  displayMessage(link_msg, 'Fetching…', 'neutral')
  confirm_form.classList.add('user-initiated')
  try {
    const res = await fetch(`${API_BASE}/link-parse`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url })
    })
    const data = await res.json()
    if (!res.ok) {
      displayMessage(link_msg, `❌ ${data.error || 'Failed to parse.'}`, 'error')
      return
    }
    displayMessage(link_msg, '✅ Parsed!', 'success')
    [...confirm_form.elements].forEach(el => {
      if (el.name && data[el.name] !== undefined) el.value = data[el.name]
    })
    if (!confirm_form.elements.application_date.value)
      confirm_form.elements.application_date.value =
        new Date().toISOString().split('T')[0]
    confirm_form.classList.remove('hidden')
  } catch {
    displayMessage(link_msg, '❌ Network error.', 'error')
  }
})

confirm_form.addEventListener('submit', async e => {
  e.preventDefault()
  displayMessage(submit_msg, '', '')
  const { data: { session }, error: sessErr } = await sb.auth.getSession()
  if (sessErr || !session) {
    displayMessage(submit_msg, 'Auth error. Log in.', 'error')
    return
  }
  const payload = Object.fromEntries(new FormData(confirm_form))
  if (payload.application_date === '') payload.application_date = null
  if (payload.deadline === '') payload.deadline = null
  displayMessage(submit_msg, 'Saving...', 'neutral')
  try {
    const res = await fetch(`${API_BASE}/submit`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: 'Bearer ' + session.access_token
      },
      body: JSON.stringify(payload)
    })
    const out = await res.json()
    if (res.ok && out.data?.length) {
      displayMessage(submit_msg, '✅ Saved!', 'success')
      gridApi.applyTransaction({ add: [out.data[0]], addIndex: 0 })
      confirm_form.reset()
      confirm_form.classList.add('hidden')
      confirm_form.classList.remove('user-initiated')
      job_url_input.value = ''
      link_msg.textContent = ''
      link_msg.className = 'message'
    } else {
      displayMessage(submit_msg, `❌ ${out.error || 'Failed to save.'}`, 'error')
    }
  } catch {
    displayMessage(submit_msg, '❌ Network error during save.', 'error')
  }
})

const columnDefs = [
  { headerName: 'Company', field: 'company', editable: true, filter: 'agTextColumnFilter', sortable: true, resizable: true, suppressMenu: true, wrapText: true, autoHeight: true },
  { headerName: 'Position', field: 'position', editable: true, filter: 'agTextColumnFilter', sortable: true, resizable: true, suppressMenu: true, wrapText: true, autoHeight: true },
  { headerName: 'Location', field: 'location', editable: true, filter: 'agTextColumnFilter', sortable: true, resizable: true, suppressMenu: true, wrapText: true, autoHeight: true },
  { headerName: 'Type', field: 'job_type', editable: true, cellEditor: 'agSelectCellEditor', cellEditorParams: { values: ['', 'Internship', 'Full-Time', 'Contract', 'Part-Time'] }, filter: 'agSetColumnFilter', sortable: true, resizable: true, suppressMenu: true, minWidth: 120 },
  { headerName: 'Applied', field: 'application_date', editable: true, filter: 'agDateColumnFilter', sortable: true, resizable: true, cellEditor: 'agDateCellEditor', filterParams: { comparator: dateFilterComparator }, suppressMenu: true, minWidth: 150 },
  { headerName: 'Deadline', field: 'deadline', editable: true, filter: 'agDateColumnFilter', sortable: true, resizable: true, cellEditor: 'agDateCellEditor', filterParams: { comparator: dateFilterComparator }, suppressMenu: true, minWidth: 150 },
  { headerName: 'Status', field: 'status', editable: true, cellEditor: 'agSelectCellEditor', cellEditorParams: { values: ['Applied', 'Interview', 'Offer', 'Rejected', 'Wishlist'] }, filter: 'agSetColumnFilter', sortable: true, resizable: true, suppressMenu: true, minWidth: 130 },
  { headerName: 'Notes', field: 'notes', editable: true, cellEditor: 'agLargeTextCellEditor', cellEditorPopup: true, resizable: true, wrapText: true, autoHeight: true, minWidth: 200, suppressMenu: true },
  { headerName: 'Job URL', field: 'job_url', resizable: true, sortable: false, filter: false, editable: true, cellRenderer: params => params.value ? `<a href="${params.value.startsWith('http') ? params.value : 'http://' + params.value}" target="_blank" rel="noopener noreferrer" class="grid-link">View</a>` : '', suppressMenu: true, minWidth: 100 },
  { headerName: 'Actions', field: 'id', width: 80, pinned: 'right', cellRenderer: params => { const btn = document.createElement('button'); btn.classList.add('delete-row-btn'); btn.innerHTML = '&#x1F5D1;'; btn.title = 'Delete Application'; btn.addEventListener('click', () => handleDeleteRow(params.node.data)); return btn; }, editable: false, sortable: false, filter: false, resizable: false, suppressMenu: true }
]

function dateFilterComparator(filterDate, cellValue) {
  if (!cellValue) return -1
  const cellDate = new Date(cellValue)
  if (isNaN(cellDate)) return -1
  if (cellDate < filterDate) return -1
  if (cellDate > filterDate) return 1
  return 0
}

const gridOptions = {
  columnDefs,
  rowData: null,
  enableBrowserTooltips: false,
  tooltipShowDelay: 0,
  domLayout: 'normal',
  defaultColDef: {
    minWidth: 100,
    floatingFilter: true,
    resizable: true,
    sortable: true,
    tooltipValueGetter: () => null,
    suppressMenu: true,
    wrapText: true,
    autoHeight: true
  },
  headerHeight: 48,
  floatingFiltersHeight: 30,
  pagination: true,
  paginationPageSize: 20,
  paginationPageSizeSelector: [10, 20, 50, 100],
  rowSelection: 'single',
  getRowId: params => params.data.id,
  deltaRowDataMode: true,
  onCellValueChanged: async event => {
    const { error } = await sb.from('applications').update(event.data).eq('id', event.data.id)
    if (error) console.error('Update failed:', error)
  },
  onGridReady: params => {
    gridApi = params.api
    if (currentUser) fetchAndSetGridData()
  }
}

async function fetchAndSetGridData() {
  gridApi.showLoadingOverlay()
  const { data, error } = await sb.from('applications').select('*').order('application_date', { ascending: false })
  if (error) {
    alert(`Error loading data: ${error.message}`)
    gridApi.hideOverlay()
    return
  }
  gridApi.setRowData(data)
  gridApi.hideOverlay()
}

function loadGrid() {
  if (gridApi) fetchAndSetGridData()
  else agGrid.createGrid(grid_div, gridOptions)
}

async function handleDeleteRow(rowData) {
  if (!confirm(`Delete "${rowData.position}" at "${rowData.company}"?`)) return
  const { error } = await sb.from('applications').delete().eq('id', rowData.id)
  if (error) alert(`Delete failed: ${error.message}`)
  else gridApi.applyTransaction({ remove: [rowData] })
}

add_row_btn.addEventListener('click', async () => {
  const newDate = new Date().toISOString().split('T')[0]
  const blank = { company: 'New Company', position: 'New Position', application_date: newDate, status: 'Wishlist' }
  const { data, error } = await sb.from('applications').insert(blank).select()
  if (error) alert(`Insert failed: ${error.message}`)
  else gridApi.applyTransaction({ add: [data[0]], addIndex: 0 })
})

export_csv_btn.addEventListener('click', () => {
  if (gridApi) gridApi.exportDataAsCsv({ fileName: 'applications.csv' })
  else alert('Grid not ready for export')
})
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('[title]').forEach(el => {
    if (!el.getAttribute('title').trim()) el.removeAttribute('title')
  })
})
</script>
</body>
</html>
